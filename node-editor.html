<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTrade AI - ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¡ä»¶ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #1a1a2e;
            color: #fff;
            overflow: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: #0f0f23;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 2px solid #2a2a4e;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background: #2a2a4e;
            color: white;
        }

        .btn:hover {
            background: #3a3a5e;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            width: 250px;
            height: calc(100vh - 60px);
            background: #0f0f23;
            border-right: 2px solid #2a2a4e;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            font-size: 14px;
            text-transform: uppercase;
            color: #8892b0;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .node-template {
            background: #2a2a4e;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .node-template:hover {
            background: #3a3a5e;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .node-template:active {
            cursor: grabbing;
        }

        .node-category {
            margin-bottom: 30px;
        }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        .canvas-container {
            position: fixed;
            left: 250px;
            top: 60px;
            right: 0;
            bottom: 0;
            background: #16213e;
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
        }

        #canvas {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* ãƒãƒ¼ãƒ‰ */
        .node {
            position: absolute;
            background: #2a2a4e;
            border: 2px solid #3a3a5e;
            border-radius: 10px;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            cursor: move;
            user-select: none;
        }

        .node.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3), 0 4px 20px rgba(0,0,0,0.5);
        }

        .node-header {
            background: #1a1a2e;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .node-type-input .node-header { background: #2d3561; }
        .node-type-condition .node-header { background: #4a5f7a; }
        .node-type-action .node-header { background: #5e4c7a; }
        .node-type-output .node-header { background: #4c7a5e; }

        .node-close {
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .node-close:hover {
            background: #ef4444;
        }

        .node-body {
            padding: 15px;
        }

        .node-field {
            margin-bottom: 10px;
        }

        .node-field label {
            font-size: 12px;
            color: #8892b0;
            display: block;
            margin-bottom: 5px;
        }

        .node-field input,
        .node-field select {
            width: 100%;
            padding: 6px 10px;
            background: #1a1a2e;
            border: 1px solid #3a3a5e;
            border-radius: 4px;
            color: white;
            font-size: 13px;
        }

        /* ãƒãƒ¼ãƒˆ */
        .port {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #4a5f7a;
            border: 2px solid #8892b0;
            border-radius: 50%;
            cursor: crosshair;
            z-index: 10;
        }

        .port:hover {
            background: #667eea;
            border-color: #667eea;
        }

        .port-input {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port-output {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port.connected {
            background: #10b981;
            border-color: #10b981;
        }

        /* æ¥ç¶šç·š */
        .connection {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }

        .connection-path {
            stroke: #667eea;
            stroke-width: 3;
            fill: none;
            filter: drop-shadow(0 0 5px rgba(102, 126, 234, 0.5));
        }

        .connection-path.preview {
            stroke-dasharray: 5;
            opacity: 0.5;
        }

        /* å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .context-menu {
            position: absolute;
            background: #0f0f23;
            border: 1px solid #2a2a4e;
            border-radius: 8px;
            padding: 5px 0;
            min-width: 150px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #2a2a4e;
        }

        /* ã‚¤ãƒ³ãƒ•ã‚©ãƒ‘ãƒãƒ« */
        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 270px;
            background: #0f0f23;
            padding: 15px 20px;
            border-radius: 8px;
            border: 2px solid #2a2a4e;
            font-size: 13px;
        }

        .info-panel span {
            margin-right: 20px;
            color: #8892b0;
        }

        .info-panel .value {
            color: #667eea;
            font-weight: 600;
        }

        /* å®Ÿè¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .execution-preview {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            background: #0f0f23;
            border: 2px solid #2a2a4e;
            border-radius: 8px;
            padding: 20px;
            display: none;
        }

        .execution-preview h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .execution-step {
            background: #2a2a4e;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .execution-step.active {
            background: #3a3a5e;
            border: 1px solid #667eea;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="logo">
            <div class="logo-icon">ğŸ”—</div>
            <span>AutoTrade AI - ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</span>
        </div>
        <div class="toolbar">
            <button class="btn" onclick="clearCanvas()">ã‚¯ãƒªã‚¢</button>
            <button class="btn" onclick="validateFlow()">æ¤œè¨¼</button>
            <button class="btn" onclick="previewExecution()">å®Ÿè¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
            <button class="btn btn-primary" onclick="saveStrategy()">æˆ¦ç•¥ã‚’ä¿å­˜</button>
        </div>
    </div>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
        <div class="node-category">
            <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹</h3>
            <div class="node-template" draggable="true" data-type="input" data-subtype="sentiment">
                <div>ğŸ­ ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æ</div>
                <small style="color: #8892b0; font-size: 11px;">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®å¸‚å ´æ„Ÿæƒ…</small>
            </div>
            <div class="node-template" draggable="true" data-type="input" data-subtype="price">
                <div>ğŸ’° ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿</div>
                <small style="color: #8892b0; font-size: 11px;">ç¾åœ¨ã®å¸‚å ´ä¾¡æ ¼</small>
            </div>
            <div class="node-template" draggable="true" data-type="input" data-subtype="keyword">
                <div>ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º</div>
                <small style="color: #8892b0; font-size: 11px;">SNSãƒˆãƒ¬ãƒ³ãƒ‰ç›£è¦–</small>
            </div>
            <div class="node-template" draggable="true" data-type="input" data-subtype="volume">
                <div>ğŸ“ˆ å–å¼•é‡</div>
                <small style="color: #8892b0; font-size: 11px;">å‡ºæ¥é«˜ãƒ‡ãƒ¼ã‚¿</small>
            </div>
        </div>

        <div class="node-category">
            <h3>âš¡ æ¡ä»¶ãƒ»ãƒ­ã‚¸ãƒƒã‚¯</h3>
            <div class="node-template" draggable="true" data-type="condition" data-subtype="compare">
                <div>âš–ï¸ æ¯”è¼ƒ</div>
                <small style="color: #8892b0; font-size: 11px;">å¤§å°æ¯”è¼ƒã€ç­‰ä¾¡åˆ¤å®š</small>
            </div>
            <div class="node-template" draggable="true" data-type="condition" data-subtype="and">
                <div>ğŸ”€ ANDæ¡ä»¶</div>
                <small style="color: #8892b0; font-size: 11px;">è¤‡æ•°æ¡ä»¶ã®åŒæ™‚æˆç«‹</small>
            </div>
            <div class="node-template" draggable="true" data-type="condition" data-subtype="or">
                <div>ğŸ”„ ORæ¡ä»¶</div>
                <small style="color: #8892b0; font-size: 11px;">ã„ãšã‚Œã‹ã®æ¡ä»¶æˆç«‹</small>
            </div>
            <div class="node-template" draggable="true" data-type="condition" data-subtype="threshold">
                <div>ğŸ¯ ã—ãã„å€¤</div>
                <small style="color: #8892b0; font-size: 11px;">ä¸Šé™ãƒ»ä¸‹é™ã®è¨­å®š</small>
            </div>
        </div>

        <div class="node-category">
            <h3>ğŸ¬ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <div class="node-template" draggable="true" data-type="action" data-subtype="buy">
                <div>ğŸ’¸ è²·ã„æ³¨æ–‡</div>
                <small style="color: #8892b0; font-size: 11px;">è³¼å…¥å®Ÿè¡Œ</small>
            </div>
            <div class="node-template" draggable="true" data-type="action" data-subtype="sell">
                <div>ğŸ’¹ å£²ã‚Šæ³¨æ–‡</div>
                <small style="color: #8892b0; font-size: 11px;">å£²å´å®Ÿè¡Œ</small>
            </div>
            <div class="node-template" draggable="true" data-type="action" data-subtype="alert">
                <div>ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆ</div>
                <small style="color: #8892b0; font-size: 11px;">é€šçŸ¥é€ä¿¡</small>
            </div>
        </div>

        <div class="node-category">
            <h3>ğŸ¯ å‡ºåŠ›</h3>
            <div class="node-template" draggable="true" data-type="output" data-subtype="execute">
                <div>âœ… å®Ÿè¡Œ</div>
                <small style="color: #8892b0; font-size: 11px;">æœ€çµ‚çš„ãªå®Ÿè¡Œãƒãƒ¼ãƒ‰</small>
            </div>
        </div>
    </div>

    <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <div class="canvas-container">
        <div id="canvas">
            <svg id="connections" style="position: absolute; width: 100%; height: 100%; pointer-events: none;">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#667eea" />
                    </marker>
                </defs>
            </svg>
        </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒ•ã‚©ãƒ‘ãƒãƒ« -->
    <div class="info-panel">
        <span>ãƒãƒ¼ãƒ‰æ•°: <span class="value" id="nodeCount">0</span></span>
        <span>æ¥ç¶šæ•°: <span class="value" id="connectionCount">0</span></span>
        <span>ãƒ’ãƒ³ãƒˆ: ãƒãƒ¼ãƒ‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§é…ç½®ã€ãƒãƒ¼ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¥ç¶š</span>
    </div>

    <!-- å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="deleteNode()">å‰Šé™¤</div>
        <div class="context-menu-item" onclick="duplicateNode()">è¤‡è£½</div>
        <div class="context-menu-item" onclick="editNode()">ç·¨é›†</div>
    </div>

    <!-- å®Ÿè¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div class="execution-preview" id="executionPreview">
        <h3>å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
        <div id="executionSteps"></div>
    </div>

    <script>
        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let connectingFrom = null;
        let nodeIdCounter = 0;
        let draggedNode = null;
        let dragOffset = { x: 0, y: 0 };

        const canvas = document.getElementById('canvas');
        const svg = document.getElementById('connections');

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒãƒ¼ãƒ‰è¿½åŠ 
        document.querySelectorAll('.node-template').forEach(template => {
            template.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', template.dataset.type);
                e.dataTransfer.setData('subtype', template.dataset.subtype);
            });
        });

        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            const subtype = e.dataTransfer.getData('subtype');
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            createNode(type, subtype, x, y);
        });

        // ãƒãƒ¼ãƒ‰ä½œæˆé–¢æ•°
        function createNode(type, subtype, x, y) {
            const node = {
                id: nodeIdCounter++,
                type: type,
                subtype: subtype,
                x: x,
                y: y
            };
            
            const nodeElement = document.createElement('div');
            nodeElement.className = `node node-type-${type}`;
            nodeElement.id = `node-${node.id}`;
            nodeElement.style.left = x + 'px';
            nodeElement.style.top = y + 'px';
            
            let content = '';
            let title = '';
            let hasInput = true;
            let hasOutput = true;
            
            // ãƒãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã”ã¨ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            switch(subtype) {
                case 'sentiment':
                    title = 'ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆåˆ†æ';
                    hasInput = false;
                    content = '<div class="node-field"><label>æ›´æ–°é »åº¦</label><select><option>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </option><option>1åˆ†ã”ã¨</option><option>5åˆ†ã”ã¨</option></select></div>';
                    break;
                case 'price':
                    title = 'ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿';
                    hasInput = false;
                    content = '<div class="node-field"><label>é€šè²¨ãƒšã‚¢</label><select><option>BTC/JPY</option><option>ETH/JPY</option><option>XRP/JPY</option></select></div>';
                    break;
                case 'keyword':
                    title = 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œå‡º';
                    hasInput = false;
                    content = '<div class="node-field"><label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label><input type="text" placeholder="ä¾‹: è¦åˆ¶, æš´è½" value="è¦åˆ¶"></div>';
                    break;
                case 'compare':
                    title = 'æ¯”è¼ƒ';
                    content = '<div class="node-field"><label>æ¡ä»¶</label><select><option>ã‚ˆã‚Šå¤§ãã„</option><option>ã‚ˆã‚Šå°ã•ã„</option><option>ç­‰ã—ã„</option></select></div><div class="node-field"><label>å€¤</label><input type="number" value="80"></div>';
                    break;
                case 'and':
                    title = 'ANDæ¡ä»¶';
                    content = '<div style="text-align: center; padding: 20px;">ã™ã¹ã¦ã®å…¥åŠ›ãŒ<br>çœŸã®å ´åˆã«å‡ºåŠ›</div>';
                    break;
                case 'buy':
                    title = 'è²·ã„æ³¨æ–‡';
                    hasOutput = false;
                    content = '<div class="node-field"><label>æ•°é‡</label><input type="number" value="0.01" step="0.01"></div><div class="node-field"><label>å˜ä½</label><select><option>BTC</option><option>å††ç›¸å½“</option></select></div>';
                    break;
                case 'sell':
                    title = 'å£²ã‚Šæ³¨æ–‡';
                    hasOutput = false;
                    content = '<div class="node-field"><label>æ•°é‡</label><input type="number" value="0.01" step="0.01"></div><div class="node-field"><label>å˜ä½</label><select><option>BTC</option><option>ï¼…</option></select></div>';
                    break;
                case 'execute':
                    title = 'å®Ÿè¡Œ';
                    hasOutput = false;
                    content = '<div style="text-align: center; padding: 20px;">æ¡ä»¶æˆç«‹æ™‚ã«<br>å®Ÿè¡Œã•ã‚Œã¾ã™</div>';
                    break;
            }
            
            nodeElement.innerHTML = `
                <div class="node-header">
                    <span>${title}</span>
                    <span class="node-close" onclick="deleteNodeById(${node.id})">Ã—</span>
                </div>
                <div class="node-body">
                    ${hasInput ? '<div class="port port-input" data-node-id="' + node.id + '" data-type="input"></div>' : ''}
                    ${hasOutput ? '<div class="port port-output" data-node-id="' + node.id + '" data-type="output"></div>' : ''}
                    ${content}
                </div>
            `;
            
            canvas.appendChild(nodeElement);
            
            // ãƒãƒ¼ãƒ‰ã®ãƒ‰ãƒ©ãƒƒã‚°
            nodeElement.addEventListener('mousedown', startDragNode);
            
            // ãƒãƒ¼ãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            nodeElement.querySelectorAll('.port').forEach(port => {
                port.addEventListener('click', handlePortClick);
            });
            
            // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            nodeElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, node.id);
            });
            
            nodes.push(node);
            updateInfo();
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            nodeElement.classList.add('pulse');
            setTimeout(() => nodeElement.classList.remove('pulse'), 500);
        }

        // ãƒãƒ¼ãƒ‰ã®ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†
        function startDragNode(e) {
            if (e.target.classList.contains('port') || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                return;
            }
            
            const nodeElement = e.currentTarget;
            const nodeId = parseInt(nodeElement.id.replace('node-', ''));
            const node = nodes.find(n => n.id === nodeId);
            
            draggedNode = node;
            dragOffset.x = e.clientX - node.x;
            dragOffset.y = e.clientY - node.y;
            
            document.addEventListener('mousemove', dragNode);
            document.addEventListener('mouseup', stopDragNode);
        }

        function dragNode(e) {
            if (!draggedNode) return;
            
            const rect = canvas.getBoundingClientRect();
            draggedNode.x = e.clientX - rect.left - dragOffset.x;
            draggedNode.y = e.clientY - rect.top - dragOffset.y;
            
            const nodeElement = document.getElementById(`node-${draggedNode.id}`);
            nodeElement.style.left = draggedNode.x + 'px';
            nodeElement.style.top = draggedNode.y + 'px';
            
            updateConnections();
        }

        function stopDragNode() {
            draggedNode = null;
            document.removeEventListener('mousemove', dragNode);
            document.removeEventListener('mouseup', stopDragNode);
        }

        // ãƒãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handlePortClick(e) {
            e.stopPropagation();
            const port = e.target;
            const nodeId = parseInt(port.dataset.nodeId);
            const portType = port.dataset.type;
            
            if (connectingFrom === null) {
                // æ¥ç¶šé–‹å§‹
                connectingFrom = { nodeId, portType, element: port };
                port.classList.add('connecting');
                canvas.addEventListener('mousemove', drawPreviewConnection);
            } else {
                // æ¥ç¶šå®Œäº†
                if (connectingFrom.portType !== portType && connectingFrom.nodeId !== nodeId) {
                    createConnection(connectingFrom.nodeId, nodeId);
                }
                cancelConnection();
            }
        }

        // æ¥ç¶šç·šã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function drawPreviewConnection(e) {
            // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤
            const existingPreview = svg.querySelector('.preview');
            if (existingPreview) existingPreview.remove();
            
            const rect = canvas.getBoundingClientRect();
            const fromPort = connectingFrom.element;
            const fromRect = fromPort.getBoundingClientRect();
            
            const x1 = fromRect.left - rect.left + fromRect.width / 2;
            const y1 = fromRect.top - rect.top + fromRect.height / 2;
            const x2 = e.clientX - rect.left;
            const y2 = e.clientY - rect.top;
            
            const path = createPath(x1, y1, x2, y2);
            path.classList.add('preview');
            svg.appendChild(path);
        }

        // æ¥ç¶šä½œæˆ
        function createConnection(fromNodeId, toNodeId) {
            const connection = {
                id: connections.length,
                from: fromNodeId,
                to: toNodeId
            };
            
            connections.push(connection);
            updateConnections();
            updateInfo();
        }

        // æ¥ç¶šç·šã®æ›´æ–°
        function updateConnections() {
            // æ—¢å­˜ã®æ¥ç¶šç·šã‚’å‰Šé™¤ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»¥å¤–ï¼‰
            svg.querySelectorAll('.connection-path:not(.preview)').forEach(path => path.remove());
            
            connections.forEach(conn => {
                const fromNode = document.querySelector(`#node-${conn.from} .port-output`);
                const toNode = document.querySelector(`#node-${conn.to} .port-input`);
                
                if (fromNode && toNode) {
                    const rect = canvas.getBoundingClientRect();
                    const fromRect = fromNode.getBoundingClientRect();
                    const toRect = toNode.getBoundingClientRect();
                    
                    const x1 = fromRect.left - rect.left + fromRect.width / 2;
                    const y1 = fromRect.top - rect.top + fromRect.height / 2;
                    const x2 = toRect.left - rect.left + toRect.width / 2;
                    const y2 = toRect.top - rect.top + toRect.height / 2;
                    
                    const path = createPath(x1, y1, x2, y2);
                    svg.appendChild(path);
                    
                    fromNode.classList.add('connected');
                    toNode.classList.add('connected');
                }
            });
        }

        // ãƒ™ã‚¸ã‚§æ›²ç·šãƒ‘ã‚¹ã‚’ä½œæˆ
        function createPath(x1, y1, x2, y2) {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const dx = Math.abs(x2 - x1);
            const cp1x = x1 + dx * 0.5;
            const cp2x = x2 - dx * 0.5;
            
            const d = `M ${x1} ${y1} C ${cp1x} ${y1}, ${cp2x} ${y2}, ${x2} ${y2}`;
            path.setAttribute('d', d);
            path.setAttribute('class', 'connection-path');
            path.setAttribute('marker-end', 'url(#arrowhead)');
            
            return path;
        }

        // æ¥ç¶šã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelConnection() {
            if (connectingFrom) {
                connectingFrom.element.classList.remove('connecting');
                connectingFrom = null;
            }
            canvas.removeEventListener('mousemove', drawPreviewConnection);
            const preview = svg.querySelector('.preview');
            if (preview) preview.remove();
        }

        // ã‚¯ãƒªãƒƒã‚¯ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        canvas.addEventListener('click', () => {
            if (connectingFrom) {
                cancelConnection();
            }
        });

        // ãƒãƒ¼ãƒ‰å‰Šé™¤
        function deleteNodeById(nodeId) {
            const nodeElement = document.getElementById(`node-${nodeId}`);
            if (nodeElement) nodeElement.remove();
            
            nodes = nodes.filter(n => n.id !== nodeId);
            connections = connections.filter(c => c.from !== nodeId && c.to !== nodeId);
            
            updateConnections();
            updateInfo();
        }

        // æƒ…å ±æ›´æ–°
        function updateInfo() {
            document.getElementById('nodeCount').textContent = nodes.length;
            document.getElementById('connectionCount').textContent = connections.length;
        }

        // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        function showContextMenu(e, nodeId) {
            selectedNode = nodeId;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        // ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', () => {
            document.getElementById('contextMenu').style.display = 'none';
        });

        // ãƒãƒ¼ãƒ‰å‰Šé™¤ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
        function deleteNode() {
            if (selectedNode !== null) {
                deleteNodeById(selectedNode);
            }
        }

        // ãƒ•ãƒ­ãƒ¼æ¤œè¨¼
        function validateFlow() {
            let hasInput = false;
            let hasOutput = false;
            let message = '';
            
            nodes.forEach(node => {
                if (node.type === 'input') hasInput = true;
                if (node.type === 'output' || node.type === 'action') hasOutput = true;
            });
            
            if (!hasInput) {
                message = 'âŒ ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
            } else if (!hasOutput) {
                message = 'âŒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
            } else if (connections.length === 0) {
                message = 'âŒ ãƒãƒ¼ãƒ‰ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“';
            } else {
                message = 'âœ… ãƒ•ãƒ­ãƒ¼ã¯æœ‰åŠ¹ã§ã™ï¼';
            }
            
            alert(message);
        }

        // å®Ÿè¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function previewExecution() {
            const preview = document.getElementById('executionPreview');
            const steps = document.getElementById('executionSteps');
            
            steps.innerHTML = '';
            
            // ç°¡æ˜“çš„ãªå®Ÿè¡Œé †åºã‚’ç”Ÿæˆ
            const executionOrder = [
                '1. ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç¾åœ¨å€¤: 82ï¼‰',
                '2. è¨­å®šå€¤ï¼ˆ80ï¼‰ã¨æ¯”è¼ƒ',
                '3. æ¡ä»¶æˆç«‹: 82 > 80',
                '4. è²·ã„æ³¨æ–‡ã‚’å®Ÿè¡Œï¼ˆ0.01 BTCï¼‰',
                '5. æ³¨æ–‡é€ä¿¡å®Œäº†'
            ];
            
            executionOrder.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'execution-step';
                stepDiv.textContent = step;
                steps.appendChild(stepDiv);
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                setTimeout(() => {
                    stepDiv.classList.add('active');
                }, index * 300);
            });
            
            preview.style.display = 'block';
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
        function clearCanvas() {
            if (confirm('ã™ã¹ã¦ã®ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                nodes = [];
                connections = [];
                nodeIdCounter = 0;
                
                document.querySelectorAll('.node').forEach(node => node.remove());
                updateConnections();
                updateInfo();
            }
        }

        // æˆ¦ç•¥ä¿å­˜ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
        function saveStrategy() {
            const strategy = {
                nodes: nodes,
                connections: connections,
                timestamp: new Date().toISOString()
            };
            
            alert(`æˆ¦ç•¥ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\nãƒãƒ¼ãƒ‰æ•°: ${nodes.length}\næ¥ç¶šæ•°: ${connections.length}\n\nâ€»ã“ã‚Œã¯ãƒ¢ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã™ã€‚å®Ÿéš›ã®ä¿å­˜å‡¦ç†ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
            console.log('ä¿å­˜ã•ã‚Œã‚‹æˆ¦ç•¥ãƒ‡ãƒ¼ã‚¿:', strategy);
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ•ãƒ­ãƒ¼ã®ä½œæˆ
        function createSampleFlow() {
            // ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆãƒãƒ¼ãƒ‰
            createNode('input', 'sentiment', 100, 200);
            
            // æ¯”è¼ƒãƒãƒ¼ãƒ‰
            createNode('condition', 'compare', 350, 200);
            
            // è²·ã„æ³¨æ–‡ãƒãƒ¼ãƒ‰
            createNode('action', 'buy', 600, 200);
            
            // æ¥ç¶šã‚’ä½œæˆ
            setTimeout(() => {
                createConnection(0, 1);
                createConnection(1, 2);
                updateConnections();
            }, 100);
        }

        // åˆæœŸè¡¨ç¤ºã§ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆ
        createSampleFlow();
    </script>
</body>
</html>