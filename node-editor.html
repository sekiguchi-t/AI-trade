<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoTrade AI - „Éì„Ç∏„É•„Ç¢„É´Êù°‰ª∂„Ç®„Éá„Ç£„Çø„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #1a1a2e;
            color: #fff;
            overflow: hidden;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            background: #0f0f23;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 2px solid #2a2a4e;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background: #2a2a4e;
            color: white;
        }

        .btn:hover {
            background: #3a3a5e;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        /* „Çµ„Ç§„Éâ„Éê„Éº */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            width: 250px;
            height: calc(100vh - 60px);
            background: #0f0f23;
            border-right: 2px solid #2a2a4e;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            font-size: 14px;
            text-transform: uppercase;
            color: #8892b0;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .node-template {
            background: #2a2a4e;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .node-template:hover {
            background: #3a3a5e;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .node-template:active {
            cursor: grabbing;
        }

        .node-category {
            margin-bottom: 30px;
        }

        /* „Ç≠„É£„É≥„Éê„Çπ */
        .canvas-container {
            position: fixed;
            left: 250px;
            top: 60px;
            right: 0;
            bottom: 0;
            background: #16213e;
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
        }

        #canvas {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* „Éé„Éº„Éâ */
        .node {
            position: absolute;
            background: #2a2a4e;
            border: 2px solid #3a3a5e;
            border-radius: 10px;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            cursor: move;
            user-select: none;
        }

        .node.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3), 0 4px 20px rgba(0,0,0,0.5);
        }

        .node-header {
            background: #1a1a2e;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .node-type-input .node-header { background: #2d3561; }
        .node-type-condition .node-header { background: #4a5f7a; }
        .node-type-action .node-header { background: #5e4c7a; }
        .node-type-output .node-header { background: #4c7a5e; }

        .node-close {
            width: 20px;
            height: 20px;
            background: rgba(239, 68, 68, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .node-close:hover {
            background: #ef4444;
        }

        .node-body {
            padding: 15px;
        }

        .node-field {
            margin-bottom: 10px;
        }

        .node-field label {
            font-size: 12px;
            color: #8892b0;
            display: block;
            margin-bottom: 5px;
        }

        .node-field input,
        .node-field select {
            width: 100%;
            padding: 6px 10px;
            background: #1a1a2e;
            border: 1px solid #3a3a5e;
            border-radius: 4px;
            color: white;
            font-size: 13px;
        }

        /* „Éù„Éº„Éà */
        .port {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #4a5f7a;
            border: 2px solid #8892b0;
            border-radius: 50%;
            cursor: crosshair;
            z-index: 10;
        }

        .port:hover {
            background: #667eea;
            border-color: #667eea;
        }

        .port-input {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port-output {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .port.connected {
            background: #10b981;
            border-color: #10b981;
        }

        /* Êé•Á∂öÁ∑ö */
        .connection {
            position: absolute;
            pointer-events: none;
            z-index: 5;
        }

        .connection-path {
            stroke: #667eea;
            stroke-width: 3;
            fill: none;
            filter: drop-shadow(0 0 5px rgba(102, 126, 234, 0.5));
        }

        .connection-path.preview {
            stroke-dasharray: 5;
            opacity: 0.5;
        }

        /* Âè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº */
        .context-menu {
            position: absolute;
            background: #0f0f23;
            border: 1px solid #2a2a4e;
            border-radius: 8px;
            padding: 5px 0;
            min-width: 150px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #2a2a4e;
        }

        /* „Ç§„É≥„Éï„Ç©„Éë„Éç„É´ */
        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 270px;
            background: #0f0f23;
            padding: 15px 20px;
            border-radius: 8px;
            border: 2px solid #2a2a4e;
            font-size: 13px;
        }

        .info-panel span {
            margin-right: 20px;
            color: #8892b0;
        }

        .info-panel .value {
            color: #667eea;
            font-weight: 600;
        }

        /* ÂÆüË°å„Éó„É¨„Éì„É•„Éº */
        .execution-preview {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            background: #0f0f23;
            border: 2px solid #2a2a4e;
            border-radius: 8px;
            padding: 20px;
            display: none;
        }

        .execution-preview h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .execution-step {
            background: #2a2a4e;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .execution-step.active {
            background: #3a3a5e;
            border: 1px solid #667eea;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="header">
        <div class="logo">
            <div class="logo-icon">üîó</div>
            <span>AutoTrade AI - „Éì„Ç∏„É•„Ç¢„É´„Ç®„Éá„Ç£„Çø„Éº</span>
        </div>
        <div class="toolbar">
            <button class="btn" onclick="clearCanvas()">„ÇØ„É™„Ç¢</button>
            <button class="btn" onclick="validateFlow()">Ê§úË®º</button>
            <button class="btn" onclick="previewExecution()">ÂÆüË°å„Éó„É¨„Éì„É•„Éº</button>
            <button class="btn btn-primary" onclick="saveStrategy()">Êà¶Áï•„Çí‰øùÂ≠ò</button>
        </div>
    </div>

    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <div class="sidebar">
        <div class="node-category">
            <h3>üìä „Éá„Éº„Çø„ÇΩ„Éº„Çπ</h3>
            <div class="node-template" draggable="true" data-type="input" data-subtype="sentiment">
                <div>üé≠ „Çª„É≥„ÉÅ„É°„É≥„ÉàÂàÜÊûê</div>
                <small style="color: #8892b0; font-size: 11px;">„É™„Ç¢„É´„Çø„Ç§„É†„ÅÆÂ∏ÇÂ†¥ÊÑüÊÉÖ</small>
            </div>
            <div class="node-template" draggable="true" data-type="input" data-subtype="price">
                <div>üí∞ ‰æ°Ê†º„Éá„Éº„Çø</div>
                <small style="color: #8892b0; font-size: 11px;">ÁèæÂú®„ÅÆÂ∏ÇÂ†¥‰æ°Ê†º</small>
            </div>
            <div class="node-template" draggable="true" data-type="input" data-subtype="keyword">
                <div>üîç „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÂá∫</div>
                <small style="color: #8892b0; font-size: 11px;">SNS„Éà„É¨„É≥„ÉâÁõ£Ë¶ñ</small>
            </div>
            <div class="node-template" draggable="true" data-type="input" data-subtype="volume">
                <div>üìà ÂèñÂºïÈáè</div>
                <small style="color: #8892b0; font-size: 11px;">Âá∫Êù•È´ò„Éá„Éº„Çø</small>
            </div>
        </div>

        <div class="node-category">
            <h3>‚ö° Êù°‰ª∂„Éª„É≠„Ç∏„ÉÉ„ÇØ</h3>
            <div class="node-template" draggable="true" data-type="condition" data-subtype="compare">
                <div>‚öñÔ∏è ÊØîËºÉ</div>
                <small style="color: #8892b0; font-size: 11px;">Â§ßÂ∞èÊØîËºÉ„ÄÅÁ≠â‰æ°Âà§ÂÆö</small>
            </div>
            <div class="node-template" draggable="true" data-type="condition" data-subtype="and">
                <div>üîÄ ANDÊù°‰ª∂</div>
                <small style="color: #8892b0; font-size: 11px;">Ë§áÊï∞Êù°‰ª∂„ÅÆÂêåÊôÇÊàêÁ´ã</small>
            </div>
            <div class="node-template" draggable="true" data-type="condition" data-subtype="or">
                <div>üîÑ ORÊù°‰ª∂</div>
                <small style="color: #8892b0; font-size: 11px;">„ÅÑ„Åö„Çå„Åã„ÅÆÊù°‰ª∂ÊàêÁ´ã</small>
            </div>
            <div class="node-template" draggable="true" data-type="condition" data-subtype="threshold">
                <div>üéØ „Åó„Åç„ÅÑÂÄ§</div>
                <small style="color: #8892b0; font-size: 11px;">‰∏äÈôê„Éª‰∏ãÈôê„ÅÆË®≠ÂÆö</small>
            </div>
        </div>

        <div class="node-category">
            <h3>üé¨ „Ç¢„ÇØ„Ç∑„Éß„É≥</h3>
            <div class="node-template" draggable="true" data-type="action" data-subtype="buy">
                <div>üí∏ Ë≤∑„ÅÑÊ≥®Êñá</div>
                <small style="color: #8892b0; font-size: 11px;">Ë≥ºÂÖ•ÂÆüË°å</small>
            </div>
            <div class="node-template" draggable="true" data-type="action" data-subtype="sell">
                <div>üíπ Â£≤„ÇäÊ≥®Êñá</div>
                <small style="color: #8892b0; font-size: 11px;">Â£≤Âç¥ÂÆüË°å</small>
            </div>
            <div class="node-template" draggable="true" data-type="action" data-subtype="alert">
                <div>üîî „Ç¢„É©„Éº„Éà</div>
                <small style="color: #8892b0; font-size: 11px;">ÈÄöÁü•ÈÄÅ‰ø°</small>
            </div>
        </div>

        <div class="node-category">
            <h3>üéØ Âá∫Âäõ</h3>
            <div class="node-template" draggable="true" data-type="output" data-subtype="execute">
                <div>‚úÖ ÂÆüË°å</div>
                <small style="color: #8892b0; font-size: 11px;">ÊúÄÁµÇÁöÑ„Å™ÂÆüË°å„Éé„Éº„Éâ</small>
            </div>
        </div>
    </div>

    <!-- „Ç≠„É£„É≥„Éê„Çπ -->
    <div class="canvas-container">
        <div id="canvas">
            <svg id="connections" style="position: absolute; width: 100%; height: 100%; pointer-events: none;">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#667eea" />
                    </marker>
                </defs>
            </svg>
        </div>
    </div>

    <!-- „Ç§„É≥„Éï„Ç©„Éë„Éç„É´ -->
    <div class="info-panel">
        <span>„Éé„Éº„ÉâÊï∞: <span class="value" id="nodeCount">0</span></span>
        <span>Êé•Á∂öÊï∞: <span class="value" id="connectionCount">0</span></span>
        <span>„Éí„É≥„Éà: „Éé„Éº„Éâ„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÈÖçÁΩÆ„ÄÅ„Éù„Éº„Éà„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Êé•Á∂ö</span>
    </div>

    <!-- Âè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="deleteNode()">ÂâäÈô§</div>
        <div class="context-menu-item" onclick="duplicateNode()">Ë§áË£Ω</div>
        <div class="context-menu-item" onclick="editNode()">Á∑®ÈõÜ</div>
    </div>

    <!-- ÂÆüË°å„Éó„É¨„Éì„É•„Éº -->
    <div class="execution-preview" id="executionPreview">
        <h3>ÂÆüË°å„Éï„É≠„Éº „Éó„É¨„Éì„É•„Éº</h3>
        <div id="executionSteps"></div>
    </div>

    <script>
        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let connectingFrom = null;
        let nodeIdCounter = 0;
        let draggedNode = null;
        let dragOffset = { x: 0, y: 0 };

        const canvas = document.getElementById('canvas');
        const svg = document.getElementById('connections');

        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Åß„Éé„Éº„ÉâËøΩÂä†
        document.querySelectorAll('.node-template').forEach(template => {
            template.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('type', template.dataset.type);
                e.dataTransfer.setData('subtype', template.dataset.subtype);
            });
        });

        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            const type = e.dataTransfer.getData('type');
            const subtype = e.dataTransfer.getData('subtype');
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            createNode(type, subtype, x, y);
        });

        // „Éé„Éº„Éâ‰ΩúÊàêÈñ¢Êï∞
        function createNode(type, subtype, x, y) {
            const node = {
                id: nodeIdCounter++,
                type: type,
                subtype: subtype,
                x: x,
                y: y
            };
            
            const nodeElement = document.createElement('div');
            nodeElement.className = `node node-type-${type}`;
            nodeElement.id = `node-${node.id}`;
            nodeElement.style.left = x + 'px';
            nodeElement.style.top = y + 'px';
            
            let content = '';
            let title = '';
            let hasInput = true;
            let hasOutput = true;
            
            // „Éé„Éº„Éâ„Çø„Ç§„Éó„Åî„Å®„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ
            switch(subtype) {
                case 'sentiment':
                    title = '„Çª„É≥„ÉÅ„É°„É≥„ÉàÂàÜÊûê';
                    hasInput = false;
                    content = '<div class="node-field"><label>Êõ¥Êñ∞È†ªÂ∫¶</label><select><option>„É™„Ç¢„É´„Çø„Ç§„É†</option><option>1ÂàÜ„Åî„Å®</option><option>5ÂàÜ„Åî„Å®</option></select></div>';
                    break;
                case 'price':
                    title = '‰æ°Ê†º„Éá„Éº„Çø';
                    hasInput = false;
                    content = '<div class="node-field"><label>ÈÄöË≤®„Éö„Ç¢</label><select><option>BTC/JPY</option><option>ETH/JPY</option><option>XRP/JPY</option></select></div>';
                    break;
                case 'keyword':
                    title = '„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÂá∫';
                    hasInput = false;
                    content = '<div class="node-field"><label>„Ç≠„Éº„ÉØ„Éº„Éâ</label><input type="text" placeholder="‰æã: Ë¶èÂà∂, Êö¥ËêΩ" value="Ë¶èÂà∂"></div>';
                    break;
                case 'compare':
                    title = 'ÊØîËºÉ';
                    content = '<div class="node-field"><label>Êù°‰ª∂</label><select><option>„Çà„ÇäÂ§ß„Åç„ÅÑ</option><option>„Çà„ÇäÂ∞è„Åï„ÅÑ</option><option>Á≠â„Åó„ÅÑ</option></select></div><div class="node-field"><label>ÂÄ§</label><input type="number" value="80"></div>';
                    break;
                case 'and':
                    title = 'ANDÊù°‰ª∂';
                    content = '<div style="text-align: center; padding: 20px;">„Åô„Åπ„Å¶„ÅÆÂÖ•Âäõ„Åå<br>Áúü„ÅÆÂ†¥Âêà„Å´Âá∫Âäõ</div>';
                    break;
                case 'buy':
                    title = 'Ë≤∑„ÅÑÊ≥®Êñá';
                    hasOutput = false;
                    content = '<div class="node-field"><label>Êï∞Èáè</label><input type="number" value="0.01" step="0.01"></div><div class="node-field"><label>Âçò‰Ωç</label><select><option>BTC</option><option>ÂÜÜÁõ∏ÂΩì</option></select></div>';
                    break;
                case 'sell':
                    title = 'Â£≤„ÇäÊ≥®Êñá';
                    hasOutput = false;
                    content = '<div class="node-field"><label>Êï∞Èáè</label><input type="number" value="0.01" step="0.01"></div><div class="node-field"><label>Âçò‰Ωç</label><select><option>BTC</option><option>ÔºÖ</option></select></div>';
                    break;
                case 'execute':
                    title = 'ÂÆüË°å';
                    hasOutput = false;
                    content = '<div style="text-align: center; padding: 20px;">Êù°‰ª∂ÊàêÁ´ãÊôÇ„Å´<br>ÂÆüË°å„Åï„Çå„Åæ„Åô</div>';
                    break;
            }
            
            nodeElement.innerHTML = `
                <div class="node-header">
                    <span>${title}</span>
                    <span class="node-close" onclick="deleteNodeById(${node.id})">√ó</span>
                </div>
                <div class="node-body">
                    ${hasInput ? '<div class="port port-input" data-node-id="' + node.id + '" data-type="input"></div>' : ''}
                    ${hasOutput ? '<div class="port port-output" data-node-id="' + node.id + '" data-type="output"></div>' : ''}
                    ${content}
                </div>
            `;
            
            canvas.appendChild(nodeElement);
            
            // „Éé„Éº„Éâ„ÅÆ„Éâ„É©„ÉÉ„Ç∞
            nodeElement.addEventListener('mousedown', startDragNode);
            
            // „Éù„Éº„Éà„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            nodeElement.querySelectorAll('.port').forEach(port => {
                port.addEventListener('click', handlePortClick);
            });
            
            // Âè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº
            nodeElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, node.id);
            });
            
            nodes.push(node);
            updateInfo();
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            nodeElement.classList.add('pulse');
            setTimeout(() => nodeElement.classList.remove('pulse'), 500);
        }

        // „Éé„Éº„Éâ„ÅÆ„Éâ„É©„ÉÉ„Ç∞Âá¶ÁêÜ
        function startDragNode(e) {
            if (e.target.classList.contains('port') || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                return;
            }
            
            const nodeElement = e.currentTarget;
            const nodeId = parseInt(nodeElement.id.replace('node-', ''));
            const node = nodes.find(n => n.id === nodeId);
            
            draggedNode = node;
            dragOffset.x = e.clientX - node.x;
            dragOffset.y = e.clientY - node.y;
            
            document.addEventListener('mousemove', dragNode);
            document.addEventListener('mouseup', stopDragNode);
        }

        function dragNode(e) {
            if (!draggedNode) return;
            
            const rect = canvas.getBoundingClientRect();
            draggedNode.x = e.clientX - rect.left - dragOffset.x;
            draggedNode.y = e.clientY - rect.top - dragOffset.y;
            
            const nodeElement = document.getElementById(`node-${draggedNode.id}`);
            nodeElement.style.left = draggedNode.x + 'px';
            nodeElement.style.top = draggedNode.y + 'px';
            
            updateConnections();
        }

        function stopDragNode() {
            draggedNode = null;
            document.removeEventListener('mousemove', dragNode);
            document.removeEventListener('mouseup', stopDragNode);
        }

        // „Éù„Éº„Éà„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handlePortClick(e) {
            e.stopPropagation();
            const port = e.target;
            const nodeId = parseInt(port.dataset.nodeId);
            const portType = port.dataset.type;
            
            if (connectingFrom === null) {
                // Êé•Á∂öÈñãÂßã
                connectingFrom = { nodeId, portType, element: port };
                port.classList.add('connecting');
                canvas.addEventListener('mousemove', drawPreviewConnection);
            } else {
                // Êé•Á∂öÂÆå‰∫Ü
                if (connectingFrom.portType !== portType && connectingFrom.nodeId !== nodeId) {
                    createConnection(connectingFrom.nodeId, nodeId);
                }
                cancelConnection();
            }
        }

        // Êé•Á∂öÁ∑ö„ÅÆ„Éó„É¨„Éì„É•„Éº
        function drawPreviewConnection(e) {
            // Êó¢Â≠ò„ÅÆ„Éó„É¨„Éì„É•„Éº„ÇíÂâäÈô§
            const existingPreview = svg.querySelector('.preview');
            if (existingPreview) existingPreview.remove();
            
            const rect = canvas.getBoundingClientRect();
            const fromPort = connectingFrom.element;
            const fromRect = fromPort.getBoundingClientRect();
            
            const x1 = fromRect.left - rect.left + fromRect.width / 2;
            const y1 = fromRect.top - rect.top + fromRect.height / 2;
            const x2 = e.clientX - rect.left;
            const y2 = e.clientY - rect.top;
            
            const path = createPath(x1, y1, x2, y2);
            path.classList.add('preview');
            svg.appendChild(path);
        }

        // Êé•Á∂ö‰ΩúÊàê
        function createConnection(fromNodeId, toNodeId) {
            const connection = {
                id: connections.length,
                from: fromNodeId,
                to: toNodeId
            };
            
            connections.push(connection);
            updateConnections();
            updateInfo();
        }

        // Êé•Á∂öÁ∑ö„ÅÆÊõ¥Êñ∞
        function updateConnections() {
            // Êó¢Â≠ò„ÅÆÊé•Á∂öÁ∑ö„ÇíÂâäÈô§Ôºà„Éó„É¨„Éì„É•„Éº‰ª•Â§ñÔºâ
            svg.querySelectorAll('.connection-path:not(.preview)').forEach(path => path.remove());
            
            connections.forEach(conn => {
                const fromNode = document.querySelector(`#node-${conn.from} .port-output`);
                const toNode = document.querySelector(`#node-${conn.to} .port-input`);
                
                if (fromNode && toNode) {
                    const rect = canvas.getBoundingClientRect();
                    const fromRect = fromNode.getBoundingClientRect();
                    const toRect = toNode.getBoundingClientRect();
                    
                    const x1 = fromRect.left - rect.left + fromRect.width / 2;
                    const y1 = fromRect.top - rect.top + fromRect.height / 2;
                    const x2 = toRect.left - rect.left + toRect.width / 2;
                    const y2 = toRect.top - rect.top + toRect.height / 2;
                    
                    const path = createPath(x1, y1, x2, y2);
                    svg.appendChild(path);
                    
                    fromNode.classList.add('connected');
                    toNode.classList.add('connected');
                }
            });
        }

        // „Éô„Ç∏„ÇßÊõ≤Á∑ö„Éë„Çπ„Çí‰ΩúÊàê
        function createPath(x1, y1, x2, y2) {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const dx = Math.abs(x2 - x1);
            const cp1x = x1 + dx * 0.5;
            const cp2x = x2 - dx * 0.5;
            
            const d = `M ${x1} ${y1} C ${cp1x} ${y1}, ${cp2x} ${y2}, ${x2} ${y2}`;
            path.setAttribute('d', d);
            path.setAttribute('class', 'connection-path');
            path.setAttribute('marker-end', 'url(#arrowhead)');
            
            return path;
        }

        // Êé•Á∂ö„Ç≠„É£„É≥„Çª„É´
        function cancelConnection() {
            if (connectingFrom) {
                connectingFrom.element.classList.remove('connecting');
                connectingFrom = null;
            }
            canvas.removeEventListener('mousemove', drawPreviewConnection);
            const preview = svg.querySelector('.preview');
            if (preview) preview.remove();
        }

        // „ÇØ„É™„ÉÉ„ÇØ„Åß„Ç≠„É£„É≥„Çª„É´
        canvas.addEventListener('click', () => {
            if (connectingFrom) {
                cancelConnection();
            }
        });

        // „Éé„Éº„ÉâÂâäÈô§
        function deleteNodeById(nodeId) {
            const nodeElement = document.getElementById(`node-${nodeId}`);
            if (nodeElement) nodeElement.remove();
            
            nodes = nodes.filter(n => n.id !== nodeId);
            connections = connections.filter(c => c.from !== nodeId && c.to !== nodeId);
            
            updateConnections();
            updateInfo();
        }

        // ÊÉÖÂ†±Êõ¥Êñ∞
        function updateInfo() {
            document.getElementById('nodeCount').textContent = nodes.length;
            document.getElementById('connectionCount').textContent = connections.length;
        }

        // Âè≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éã„É•„Éº
        function showContextMenu(e, nodeId) {
            selectedNode = nodeId;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        // „ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', () => {
            document.getElementById('contextMenu').style.display = 'none';
        });

        // „Éé„Éº„ÉâÂâäÈô§Ôºà„É°„Éã„É•„Éº„Åã„ÇâÔºâ
        function deleteNode() {
            if (selectedNode !== null) {
                deleteNodeById(selectedNode);
            }
        }

        // „Éï„É≠„ÉºÊ§úË®º
        function validateFlow() {
            let hasInput = false;
            let hasOutput = false;
            let message = '';
            
            nodes.forEach(node => {
                if (node.type === 'input') hasInput = true;
                if (node.type === 'output' || node.type === 'action') hasOutput = true;
            });
            
            if (!hasInput) {
                message = '‚ùå „Éá„Éº„Çø„ÇΩ„Éº„Çπ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
            } else if (!hasOutput) {
                message = '‚ùå „Ç¢„ÇØ„Ç∑„Éß„É≥„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
            } else if (connections.length === 0) {
                message = '‚ùå „Éé„Éº„Éâ„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
            } else {
                message = '‚úÖ „Éï„É≠„Éº„ÅØÊúâÂäπ„Åß„ÅôÔºÅ';
            }
            
            alert(message);
        }

        // ÂÆüË°å„Éó„É¨„Éì„É•„Éº
        function previewExecution() {
            const preview = document.getElementById('executionPreview');
            const steps = document.getElementById('executionSteps');
            
            steps.innerHTML = '';
            
            // Á∞°ÊòìÁöÑ„Å™ÂÆüË°åÈ†ÜÂ∫è„ÇíÁîüÊàê
            const executionOrder = [
                '1. „Çª„É≥„ÉÅ„É°„É≥„Éà„Éá„Éº„Çø„ÇíÂèñÂæóÔºàÁèæÂú®ÂÄ§: 82Ôºâ',
                '2. Ë®≠ÂÆöÂÄ§Ôºà80Ôºâ„Å®ÊØîËºÉ',
                '3. Êù°‰ª∂ÊàêÁ´ã: 82 > 80',
                '4. Ë≤∑„ÅÑÊ≥®Êñá„ÇíÂÆüË°åÔºà0.01 BTCÔºâ',
                '5. Ê≥®ÊñáÈÄÅ‰ø°ÂÆå‰∫Ü'
            ];
            
            executionOrder.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'execution-step';
                stepDiv.textContent = step;
                steps.appendChild(stepDiv);
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                setTimeout(() => {
                    stepDiv.classList.add('active');
                }, index * 300);
            });
            
            preview.style.display = 'block';
        }

        // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„Ç¢
        function clearCanvas() {
            if (confirm('„Åô„Åπ„Å¶„ÅÆ„Éé„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                nodes = [];
                connections = [];
                nodeIdCounter = 0;
                
                document.querySelectorAll('.node').forEach(node => node.remove());
                updateConnections();
                updateInfo();
            }
        }

        // Êà¶Áï•‰øùÂ≠òÔºà„É¢„ÉÉ„ÇØÔºâ
        function saveStrategy() {
            const strategy = {
                nodes: nodes,
                connections: connections,
                timestamp: new Date().toISOString()
            };
            
            alert(`Êà¶Áï•„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ\n\n„Éé„Éº„ÉâÊï∞: ${nodes.length}\nÊé•Á∂öÊï∞: ${connections.length}\n\n‚Äª„Åì„Çå„ÅØ„É¢„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åß„Åô„ÄÇÂÆüÈöõ„ÅÆ‰øùÂ≠òÂá¶ÁêÜ„ÅØÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ`);
            console.log('‰øùÂ≠ò„Åï„Çå„ÇãÊà¶Áï•„Éá„Éº„Çø:', strategy);
        }

        // „Çµ„É≥„Éó„É´„Éï„É≠„Éº„ÅÆ‰ΩúÊàê
        function createSampleFlow() {
            // „Çª„É≥„ÉÅ„É°„É≥„Éà„Éé„Éº„Éâ
            createNode('input', 'sentiment', 100, 200);
            
            // ÊØîËºÉ„Éé„Éº„Éâ
            createNode('condition', 'compare', 350, 200);
            
            // Ë≤∑„ÅÑÊ≥®Êñá„Éé„Éº„Éâ
            createNode('action', 'buy', 600, 200);
            
            // Êé•Á∂ö„Çí‰ΩúÊàê
            setTimeout(() => {
                createConnection(0, 1);
                createConnection(1, 2);
                updateConnections();
            }, 100);
        }

        // ÂàùÊúüË°®Á§∫„Åß„Çµ„É≥„Éó„É´„Çí‰ΩúÊàê
        createSampleFlow();
    </script>
</body>
</html>